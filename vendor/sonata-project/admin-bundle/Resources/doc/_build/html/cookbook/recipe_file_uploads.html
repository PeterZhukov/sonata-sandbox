

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>3. Uploading and saving documents (including images) using DoctrineORM and SonataAdmin &mdash; Sonata ~ AdminBundle  documentation</title>
  

  
  

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  
    <link rel="top" title="Sonata ~ AdminBundle  documentation" href="../index.html"/>
        <link rel="next" title="4. Showing image previews" href="recipe_image_previews.html"/>
        <link rel="prev" title="2. KnpMenu" href="recipe_knp_menu.html"/> 

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        <a href="../index.html" class="fa fa-home"> Sonata ~ AdminBundle</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        
        
            <ul>
<li class="toctree-l1"><a class="reference internal" href="../reference/installation.html">1. Installation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../reference/installation.html#downloading-the-code">1.1. Downloading the code</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/installation.html#selecting-and-downloading-a-storage-bundle">1.2. Selecting and downloading a storage bundle</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/installation.html#enabling-sonataadminbundle-and-its-dependencies">1.3. Enabling SonataAdminBundle and its dependencies</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/installation.html#configuring-sonataadminbundle-dependencies">1.4. Configuring SonataAdminBundle dependencies</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/installation.html#cleaning-up">1.5. Cleaning up</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../reference/getting_started.html">2. Getting started with SonataAdminBundle</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../reference/getting_started.html#step-1-define-sonataadminbundle-routes">2.1. Step 1: Define SonataAdminBundle routes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/getting_started.html#step-2-create-an-admin-class">2.2. Step 2: Create an Admin class</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/getting_started.html#step-3-create-an-admin-service">2.3. Step 3: Create an Admin service</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/getting_started.html#step-4-configuration">2.4. Step 4: Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/getting_started.html#next-steps-security">2.5. Next steps - Security</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../reference/configuration.html">3. Configuration</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../reference/configuration.html#id1">3.1. Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/configuration.html#full-configuration-options">3.2. Full Configuration Options</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../reference/architecture.html">4. Architecture</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../reference/architecture.html#the-admin-class">4.1. The Admin Class</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/architecture.html#crudcontroller">4.2. CRUDController</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/architecture.html#fields-definition">4.3. Fields Definition</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/architecture.html#templates">4.4. Templates</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/architecture.html#managing-admin-service">4.5. Managing <tt class="docutils literal"><span class="pre">Admin</span></tt> Service</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/architecture.html#create-child-admins">4.6. Create child admins</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../reference/dashboard.html">5. Dashboard</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../reference/dashboard.html#blocks">5.1. Blocks</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/dashboard.html#the-admin-list-block">5.2. The <tt class="docutils literal"><span class="pre">Admin</span></tt> list block</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/dashboard.html#configuring-the-admin-list">5.3. Configuring the <tt class="docutils literal"><span class="pre">Admin</span></tt> list</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/dashboard.html#adding-more-blocks">5.4. Adding more Blocks</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../reference/search.html">6. Search</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../reference/search.html#customization">6.1. Customization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/search.html#performance">6.2. Performance</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../reference/action_list.html">7. The List View</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../reference/action_list.html#basic-configuration">7.1. Basic configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/action_list.html#customizing-the-fields-displayed-on-the-list-page">7.2. Customizing the fields displayed on the list page</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/action_list.html#customizing-the-query-used-to-generate-the-list">7.3. Customizing the query used to generate the list</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/action_list.html#customizing-the-sort-order">7.4. Customizing the sort order</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/action_list.html#filters">7.5. Filters</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../reference/action_create_edit.html">8. Creating and Editing objects</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../reference/action_create_edit.html#basic-configuration">8.1. Basic configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/action_create_edit.html#embedding-other-admins">8.2. Embedding other Admins</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/action_create_edit.html#customizing-just-one-of-the-actions">8.3. Customizing just one of the actions</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../reference/action_show.html">9. The Show action</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../reference/action_show.html#basic-configuration">9.1. Basic configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/action_show.html#customising-the-query-used-to-show-the-object-from-within-your-admin-class">9.2. Customising the query used to show the object from within your Admin class</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../reference/action_show.html#setting-up-a-custom-show-template-very-useful">10. Setting up a custom show template (very useful)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/action_delete.html">11. Deleting objects</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../reference/action_delete.html#basic-configuration">11.1. Basic configuration</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../reference/action_export.html">12. The Export action</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../reference/action_export.html#basic-configuration">12.1. Basic configuration</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../reference/saving_hooks.html">13. Saving hooks</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../reference/saving_hooks.html#example-used-with-the-fos-userbundle">13.1. Example used with the FOS/UserBundle</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../reference/form_types.html">14. Form Types</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../reference/form_types.html#admin-related-form-types">14.1. Admin related form types</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/form_types.html#types-options">14.2. Types options</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../reference/form_help_message.html">15. Form Help Messages and Descriptions</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../reference/form_help_message.html#help-messages">15.1. Help Messages</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/form_help_message.html#form-group-descriptions">15.2. Form Group Descriptions</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../reference/field_types.html">16. Field Types</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../reference/field_types.html#list-and-show-actions">16.1. List and Show Actions</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../reference/batch_actions.html">17. Batch actions</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../reference/batch_actions.html#defining-new-actions">17.1. Defining new actions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/batch_actions.html#optional-overriding-the-batch-selection-template">17.2. (Optional) Overriding the batch selection template</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/batch_actions.html#optional-overriding-the-default-relevancy-check-function">17.3. (Optional) Overriding the default relevancy check function</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/batch_actions.html#optional-executing-a-pre-batch-hook">17.4. (Optional) Executing a pre batch hook</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/batch_actions.html#define-the-core-action-logic">17.5. Define the core action logic</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../reference/console.html">18. Console/Command-Line Commands</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../reference/console.html#cache-create-cache-class">18.1. cache:create-cache-class</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/console.html#sonata-admin-generate">18.2. sonata:admin:generate</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/console.html#sonata-admin-list">18.3. sonata:admin:list</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/console.html#sonata-admin-explain">18.4. sonata:admin:explain</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/console.html#sonata-admin-setup-acl">18.5. sonata:admin:setup-acl</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/console.html#sonata-admin-generate-object-acl">18.6. sonata:admin:generate-object-acl</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../reference/troubleshooting.html">19. Troubleshooting</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../reference/troubleshooting.html#the-tostring-method">19.1. The toString method</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/troubleshooting.html#large-filters-and-long-urls-problem">19.2. Large filters and long urls problem</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../reference/routing.html">1. Routing</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../reference/routing.html#routing-definition">1.1. Routing Definition</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/routing.html#routing-usage">1.2. Routing usage</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/routing.html#create-a-route">1.3. Create a route</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/routing.html#removing-a-route">1.4. Removing a route</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/routing.html#persistent-parameters">1.5. Persistent parameters</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/routing.html#changing-the-default-route-in-a-list-action">1.6. Changing the default route in a List Action</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../reference/translation.html">2. Translation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../reference/translation.html#translate-field-labels">2.1. Translate field labels</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../reference/conditional_validation.html">3. Inline Validation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../reference/conditional_validation.html#troubleshooting">3.1. Troubleshooting</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../reference/templates.html">4. Templates</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../reference/templates.html#global-templates">4.1. Global Templates</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/templates.html#dashboard-template">4.2. Dashboard Template</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/templates.html#crudcontroller-actions-templates">4.3. CRUDController Actions Templates</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/templates.html#row-templates">4.4. Row Templates</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/templates.html#other-templates">4.5. Other Templates</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/templates.html#configuring-templates">4.6. Configuring templates</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../reference/security.html">5. Security</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../reference/security.html#user-management">5.1. User management</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/security.html#security-handlers">5.2. Security handlers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/security.html#role-handler">5.3. Role handler</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/security.html#acl-and-friendsofsymfony-userbundle">5.4. ACL and FriendsOfSymfony/UserBundle</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/security.html#acl-editor">5.5. ACL editor</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../reference/extensions.html">6. Extensions</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../reference/extensions.html#configuration">6.1. Configuration</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../reference/events.html">7. Events</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../reference/events.html#configureevent">7.1. ConfigureEvent</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/events.html#persistenceevent">7.2. PersistenceEvent</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/events.html#configurequeryevent">7.3. ConfigureQueryEvent</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/events.html#blockevent">7.4. BlockEvent</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../reference/advanced_configuration.html">8. Advanced configuration</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../reference/advanced_configuration.html#service-configuration">8.1. Service Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/advanced_configuration.html#inherited-classes">8.2. Inherited classes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/advanced_configuration.html#dropdowns-in-tab-menu">8.3. Dropdowns in Tab Menu</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/advanced_configuration.html#disable-content-stretching">8.4. Disable content stretching</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../reference/preview_mode.html">9. Preview Mode</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../reference/preview_mode.html#simulating-front-end-rendering">9.1. Simulating front-end rendering</a></li>
</ul>
</li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="recipe_select2.html">1. Select2</a><ul>
<li class="toctree-l2"><a class="reference internal" href="recipe_select2.html#disable-select2">1.1. Disable select2</a></li>
<li class="toctree-l2"><a class="reference internal" href="recipe_select2.html#disable-select2-on-some-form-elements">1.2. Disable select2 on some form elements</a></li>
<li class="toctree-l2"><a class="reference internal" href="recipe_select2.html#allowclear">1.3. AllowClear</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="recipe_knp_menu.html">2. KnpMenu</a><ul>
<li class="toctree-l2"><a class="reference internal" href="recipe_knp_menu.html#add-a-custom-controller-entry-in-the-menu">2.1. Add a custom controller entry in the menu</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="current reference internal" href="">3. Uploading and saving documents (including images) using DoctrineORM and SonataAdmin</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#pre-requisites">3.1. Pre-requisites</a></li>
<li class="toctree-l2"><a class="reference internal" href="#the-recipe">3.2. The recipe</a></li>
<li class="toctree-l2"><a class="reference internal" href="#notes">3.3. Notes</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="recipe_image_previews.html">4. Showing image previews</a><ul>
<li class="toctree-l2"><a class="reference internal" href="recipe_image_previews.html#pre-requisites">4.1. Pre-requisites</a></li>
<li class="toctree-l2"><a class="reference internal" href="recipe_image_previews.html#the-recipe">4.2. The recipe</a></li>
<li class="toctree-l2"><a class="reference internal" href="recipe_image_previews.html#notes">4.3. Notes</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="recipe_row_templates.html">5. Row templates</a><ul>
<li class="toctree-l2"><a class="reference internal" href="recipe_row_templates.html#the-recipe">5.1. The recipe</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="recipe_sortable_listing.html">6. Sortable behavior in admin listing</a><ul>
<li class="toctree-l2"><a class="reference internal" href="recipe_sortable_listing.html#background">6.1. Background</a></li>
<li class="toctree-l2"><a class="reference internal" href="recipe_sortable_listing.html#pre-requisites">6.2. Pre-requisites</a></li>
<li class="toctree-l2"><a class="reference internal" href="recipe_sortable_listing.html#the-recipe">6.3. The recipe</a></li>
<li class="toctree-l2"><a class="reference internal" href="recipe_sortable_listing.html#further-work">6.4. Further work</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="recipe_dynamic_form_modification.html">7. Modifying form fields dynamically depending on edited object</a></li>
<li class="toctree-l1"><a class="reference internal" href="recipe_custom_action.html">8. Creating a Custom Admin Action</a><ul>
<li class="toctree-l2"><a class="reference internal" href="recipe_custom_action.html#the-recipe">8.1. The recipe</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="recipe_customizing_a_mosaic_list.html">9. Customizing a mosaic list</a></li>
<li class="toctree-l1"><a class="reference internal" href="recipe_overwrite_admin_configuration.html">10. Overwrite Admin Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="recipe_improve_performance_large_datasets.html">11. Improve performance of large datasets</a><ul>
<li class="toctree-l2"><a class="reference internal" href="recipe_improve_performance_large_datasets.html#change-default-pager-to-simplepager">11.1. Change default Pager to SimplePager</a></li>
</ul>
</li>
</ul>

        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../index.html">Sonata ~ AdminBundle</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html">Docs</a> &raquo;</li>
      
    <li>3. Uploading and saving documents (including images) using DoctrineORM and SonataAdmin</li>
      <li class="wy-breadcrumbs-aside">
        
          <a href="../_sources/cookbook/recipe_file_uploads.txt" rel="nofollow"> View page source</a>
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            
  <div class="section" id="uploading-and-saving-documents-including-images-using-doctrineorm-and-sonataadmin">
<h1>3. Uploading and saving documents (including images) using DoctrineORM and SonataAdmin<a class="headerlink" href="#uploading-and-saving-documents-including-images-using-doctrineorm-and-sonataadmin" title="Permalink to this headline">¶</a></h1>
<p>This is a full working example of a file upload management method using
SonataAdmin with the DoctrineORM persistence layer.</p>
<div class="section" id="pre-requisites">
<h2>3.1. Pre-requisites<a class="headerlink" href="#pre-requisites" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>you already have SonataAdmin and DoctrineORM up and running</li>
<li>you already have an Entity class that you wish to be able to connect uploaded
documents to, in this example that class will be called <tt class="docutils literal"><span class="pre">Image</span></tt>.</li>
<li>you already have an Admin set up, in this example it&#8217;s called <tt class="docutils literal"><span class="pre">ImageAdmin</span></tt></li>
<li>you understand file permissions on your web server and can manage the permissions
needed to allow your web server to upload and update files in the relevant
folder(s)</li>
</ul>
</div>
<div class="section" id="the-recipe">
<h2>3.2. The recipe<a class="headerlink" href="#the-recipe" title="Permalink to this headline">¶</a></h2>
<p>First we will cover the basics of what your Entity needs to contain to enable document
management with Doctrine. There is a good cookbook entry about
<a class="reference external" href="http://symfony.com/doc/current/cookbook/doctrine/file_uploads.html">uploading files with Doctrine and Symfony</a> on the Symfony website, so I will show
code examples here without going into the details. It is strongly recommended that
you read that cookbook first.</p>
<p>To get file uploads working with SonataAdmin we need to:</p>
<ul class="simple">
<li>add a file upload field to our ImageAdmin</li>
<li>&#8216;touch&#8217; the Entity when a new file is uploaded so its lifecycle events are triggered</li>
</ul>
<div class="section" id="basic-configuration-the-entity">
<h3>3.2.1. Basic configuration - the Entity<a class="headerlink" href="#basic-configuration-the-entity" title="Permalink to this headline">¶</a></h3>
<p>Following the guidelines from the Symfony cookbook, we have an Entity definition
that looks something like the YAML below (of course, you can achieve something
similar with XML or Annotation based definitions too). In this example we are using
the <tt class="docutils literal"><span class="pre">updated</span></tt> field to trigger the lifecycle callbacks by setting it based on the
upload timestamp.</p>
<div class="configuration-block">
<ul class="simple">
<li><em>YAML</em><div class="highlight-yaml"><div class="highlight"><pre><span class="c1"># YourNS/YourBundle/Resources/config/Doctrine/Image.orm.yml</span>

<span class="l-Scalar-Plain">YourNS\YourBundle\Entity\Image</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">entity</span>
  <span class="l-Scalar-Plain">repositoryClass</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">YourNS\YourBundle\Entity\Repositories\ImageRepository</span>
  <span class="l-Scalar-Plain">table</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">images</span>
  <span class="l-Scalar-Plain">id</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">id</span><span class="p-Indicator">:</span>
      <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span>         <span class="l-Scalar-Plain">integer</span>
      <span class="l-Scalar-Plain">generator</span><span class="p-Indicator">:</span>    <span class="p-Indicator">{</span> <span class="nv">strategy</span><span class="p-Indicator">:</span> <span class="nv">AUTO</span> <span class="p-Indicator">}</span>
  <span class="l-Scalar-Plain">fields</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">filename</span><span class="p-Indicator">:</span>
      <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span>         <span class="l-Scalar-Plain">string</span>
      <span class="l-Scalar-Plain">length</span><span class="p-Indicator">:</span>       <span class="l-Scalar-Plain">100</span>
    <span class="l-Scalar-Plain">updated</span><span class="p-Indicator">:</span>        <span class="c1"># changed when files are uploaded, to force preUpdate and postUpdate to fire</span>
      <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span>         <span class="l-Scalar-Plain">datetime</span>
      <span class="l-Scalar-Plain">nullable</span><span class="p-Indicator">:</span>     <span class="l-Scalar-Plain">true</span>
    <span class="c1"># ... other fields ...</span>
  <span class="l-Scalar-Plain">lifecycleCallbacks</span><span class="p-Indicator">:</span>
      <span class="l-Scalar-Plain">prePersist</span><span class="p-Indicator">:</span>   <span class="p-Indicator">[</span> <span class="nv">lifecycleFileUpload</span> <span class="p-Indicator">]</span>
      <span class="l-Scalar-Plain">preUpdate</span><span class="p-Indicator">:</span>    <span class="p-Indicator">[</span> <span class="nv">lifecycleFileUpload</span> <span class="p-Indicator">]</span>
</pre></div>
</div>
</li>
</ul>
</div>
<p>We then have the following methods in our <tt class="docutils literal"><span class="pre">Image</span></tt> class to manage file uploads:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="x">// YourNS/YourBundle/Entity/Image.php</span>
<span class="x">const SERVER_PATH_TO_IMAGE_FOLDER = &#39;/server/path/to/images&#39;;</span>

<span class="x">/**</span>
<span class="x"> * Unmapped property to handle file uploads</span>
<span class="x"> */</span>
<span class="x">private $file;</span>

<span class="x">/**</span>
<span class="x"> * Sets file.</span>
<span class="x"> *</span>
<span class="x"> * @param UploadedFile $file</span>
<span class="x"> */</span>
<span class="x">public function setFile(UploadedFile $file = null)</span>
<span class="x">{</span>
<span class="x">    $this-&gt;file = $file;</span>
<span class="x">}</span>

<span class="x">/**</span>
<span class="x"> * Get file.</span>
<span class="x"> *</span>
<span class="x"> * @return UploadedFile</span>
<span class="x"> */</span>
<span class="x">public function getFile()</span>
<span class="x">{</span>
<span class="x">    return $this-&gt;file;</span>
<span class="x">}</span>

<span class="x">/**</span>
<span class="x"> * Manages the copying of the file to the relevant place on the server</span>
<span class="x"> */</span>
<span class="x">public function upload()</span>
<span class="x">{</span>
<span class="x">    // the file property can be empty if the field is not required</span>
<span class="x">    if (null === $this-&gt;getFile()) {</span>
<span class="x">        return;</span>
<span class="x">    }</span>

<span class="x">    // we use the original file name here but you should</span>
<span class="x">    // sanitize it at least to avoid any security issues</span>

<span class="x">    // move takes the target directory and target filename as params</span>
<span class="x">    $this-&gt;getFile()-&gt;move(</span>
<span class="x">        Image::SERVER_PATH_TO_IMAGE_FOLDER,</span>
<span class="x">        $this-&gt;getFile()-&gt;getClientOriginalName()</span>
<span class="x">    );</span>

<span class="x">    // set the path property to the filename where you&#39;ve saved the file</span>
<span class="x">    $this-&gt;filename = $this-&gt;getFile()-&gt;getClientOriginalName();</span>

<span class="x">    // clean up the file property as you won&#39;t need it anymore</span>
<span class="x">    $this-&gt;setFile(null);</span>
<span class="x">}</span>

<span class="x">/**</span>
<span class="x"> * Lifecycle callback to upload the file to the server</span>
<span class="x"> */</span>
<span class="x">public function lifecycleFileUpload() {</span>
<span class="x">    $this-&gt;upload();</span>
<span class="x">}</span>

<span class="x">/**</span>
<span class="x"> * Updates the hash value to force the preUpdate and postUpdate events to fire</span>
<span class="x"> */</span>
<span class="x">public function refreshUpdated() {</span>
<span class="x">    $this-&gt;setUpdated(new \DateTime(&quot;now&quot;));</span>
<span class="x">}</span>

<span class="x">// ... the rest of your class lives under here, including the generated fields</span>
<span class="x">//     such as filename and updated</span>
</pre></div>
</div>
<p>When we upload a file to our Image, the file itself is transient and not persisted
to our database (it is not part of our mapping). However, the lifecycle callbacks
trigger a call to <tt class="docutils literal"><span class="pre">Image::upload()</span></tt> which manages the actual copying of the
uploaded file to the filesystem and updates the <tt class="docutils literal"><span class="pre">filename</span></tt> property of our Image,
this filename field <em>is</em> persisted to the database.</p>
<p>Most of the above is simply from the <a class="reference external" href="http://symfony.com/doc/current/cookbook/doctrine/file_uploads.html">uploading files with Doctrine and Symfony</a> cookbook
entry. It is highly recommended reading!</p>
</div>
<div class="section" id="basic-configuration-the-admin-class">
<h3>3.2.2. Basic configuration - the Admin class<a class="headerlink" href="#basic-configuration-the-admin-class" title="Permalink to this headline">¶</a></h3>
<p>We need to do two things in Sonata to enable file uploads:</p>
<ol class="arabic simple">
<li>Add a file upload widget</li>
<li>Ensure that the Image class&#8217; lifecycle events fire when we upload a file</li>
</ol>
<p>Both of these are straightforward when you know what to do:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="x">// YourNS/YourBundle/Admin/ImageAdmin.php</span>

<span class="x">...</span>

<span class="x">class ImageAdmin extends Admin</span>
<span class="x">{</span>
<span class="x">    protected function configureFormFields(FormMapper $formMapper)</span>
<span class="x">    {</span>
<span class="x">        $formMapper</span>
<span class="x">            -&gt;add(&#39;file&#39;, &#39;file&#39;, array(&#39;required&#39; =&gt; false))</span>
<span class="x">            // ... other fields can go here ...</span>
<span class="x">        ;</span>
<span class="x">    }</span>

<span class="x">    public function prePersist($image) {</span>
<span class="x">        $this-&gt;manageFileUpload($image);</span>
<span class="x">    }</span>

<span class="x">    public function preUpdate($image) {</span>
<span class="x">        $this-&gt;manageFileUpload($image);</span>
<span class="x">    }</span>

<span class="x">    private function manageFileUpload($image) {</span>
<span class="x">        if ($image-&gt;getFile()) {</span>
<span class="x">            $image-&gt;refreshUpdated();</span>
<span class="x">        }</span>
<span class="x">    }</span>

<span class="x">    // ...</span>
<span class="x">}</span>
</pre></div>
</div>
<p>We mark the <tt class="docutils literal"><span class="pre">file</span></tt> field as not required since we do not need the user to upload a
new image every time the Image is updated. When a file is uploaded (and nothing else
is changed on the form) there is no change to the data which Doctrine needs to persist
so no <tt class="docutils literal"><span class="pre">preUpdate</span></tt> event would fire. To deal with this we hook into SonataAdmin&#8217;s
<tt class="docutils literal"><span class="pre">preUpdate</span></tt> event (which triggers every time the edit form is submitted) and use
that to update an Image field which is persisted. This then ensures that Doctrine&#8217;s
lifecycle events are triggered and our Image manages the file upload as expected.</p>
<p>And that is all there is to it!</p>
<p>However, this method does not work when the <tt class="docutils literal"><span class="pre">ImageAdmin</span></tt> is embedded in other
Admins using the <tt class="docutils literal"><span class="pre">sonata_type_admin</span></tt> field type. For that we need something more...</p>
</div>
<div class="section" id="advanced-example-works-with-embedded-admins">
<h3>3.2.3. Advanced example - works with embedded Admins<a class="headerlink" href="#advanced-example-works-with-embedded-admins" title="Permalink to this headline">¶</a></h3>
<p>When one Admin is embedded in another Admin, the child Admin&#8217;s <tt class="docutils literal"><span class="pre">preUpdate()</span></tt> method is
not triggered when the parent is submitted. To deal with this we need to use the parent
Admin&#8217;s lifecycle events to trigger the file management when needed.</p>
<p>In this example we have a Page class which has three one-to-one Image relationships
defined, linkedImage1 to linkedImage3. The PageAdmin class&#8217; form field configuration
looks like this:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="x">class PageAdmin extends Admin</span>
<span class="x">{</span>
<span class="x">    protected function configureFormFields(FormMapper $formMapper)</span>
<span class="x">    {</span>
<span class="x">        $formMapper</span>
<span class="x">            -&gt;add(&#39;linkedImage1&#39;, &#39;sonata_type_admin&#39;, array(&#39;delete&#39; =&gt; false))</span>
<span class="x">            -&gt;add(&#39;linkedImage2&#39;, &#39;sonata_type_admin&#39;, array(&#39;delete&#39; =&gt; false))</span>
<span class="x">            -&gt;add(&#39;linkedImage3&#39;, &#39;sonata_type_admin&#39;, array(&#39;delete&#39; =&gt; false))</span>
<span class="x">            // ... other fields go here ...</span>
<span class="x">        ;</span>
<span class="x">    }</span>

<span class="x">    // ...</span>
<span class="x">}</span>
</pre></div>
</div>
<p>This is easy enough - we have embedded three fields, which will then use our <tt class="docutils literal"><span class="pre">ImageAdmin</span></tt>
class to determine which fields to show.</p>
<p>In PageAdmin we then have the following code to manage the relationships&#8217; lifecycles:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="x">class PageAdmin extends Admin</span>
<span class="x">{</span>
<span class="x">    // ...</span>

<span class="x">    public function prePersist($page) {</span>
<span class="x">        $this-&gt;manageEmbeddedImageAdmins($page);</span>
<span class="x">    }</span>
<span class="x">    public function preUpdate($page) {</span>
<span class="x">        $this-&gt;manageEmbeddedImageAdmins($page);</span>
<span class="x">    }</span>
<span class="x">    private function manageEmbeddedImageAdmins($page) {</span>
<span class="x">        // Cycle through each field</span>
<span class="x">        foreach ($this-&gt;getFormFieldDescriptions() as $fieldName =&gt; $fieldDescription) {</span>
<span class="x">            // detect embedded Admins that manage Images</span>
<span class="x">            if ($fieldDescription-&gt;getType() === &#39;sonata_type_admin&#39; &amp;&amp;</span>
<span class="x">                ($associationMapping = $fieldDescription-&gt;getAssociationMapping()) &amp;&amp;</span>
<span class="x">                $associationMapping[&#39;targetEntity&#39;] === &#39;YourNS\YourBundle\Entity\Image&#39;</span>
<span class="x">            ) {</span>
<span class="x">                $getter = &#39;get&#39; . $fieldName;</span>
<span class="x">                $setter = &#39;set&#39; . $fieldName;</span>

<span class="x">                /** @var Image $image */</span>
<span class="x">                $image = $page-&gt;$getter();</span>
<span class="x">                if ($image) {</span>
<span class="x">                    if ($image-&gt;getFile()) {</span>
<span class="x">                        // update the Image to trigger file management</span>
<span class="x">                        $image-&gt;refreshUpdated();</span>
<span class="x">                    } elseif (!$image-&gt;getFile() &amp;&amp; !$image-&gt;getFilename()) {</span>
<span class="x">                        // prevent Sf/Sonata trying to create and persist an empty Image</span>
<span class="x">                        $page-&gt;$setter(null);</span>
<span class="x">                    }</span>
<span class="x">                }</span>
<span class="x">            }</span>
<span class="x">        }</span>
<span class="x">    }</span>

<span class="x">    // ...</span>
<span class="x">}</span>
</pre></div>
</div>
<p>Here we loop through the fields of our PageAdmin and look for ones which are <tt class="docutils literal"><span class="pre">sonata_type_admin</span></tt>
fields which have embedded an Admin which manages an Image.</p>
<p>Once we have those fields we use the <tt class="docutils literal"><span class="pre">$fieldName</span></tt> to build strings which refer to our accessor
and mutator methods. For example we might end up with <tt class="docutils literal"><span class="pre">getlinkedImage1</span></tt> in <tt class="docutils literal"><span class="pre">$getter</span></tt>. Using
this accessor we can get the actual Image object from the Page object under management by the
PageAdmin. Inspecting this object reveals whether it has a pending file upload - if it does we
trigger the same <tt class="docutils literal"><span class="pre">refreshUpdated()</span></tt> method as before.</p>
<p>The final check is to prevent a glitch where Symfony tries to create blank Images when nothing
has been entered in the form. We detect this case and null the relationship to stop this from
happening.</p>
</div>
</div>
<div class="section" id="notes">
<h2>3.3. Notes<a class="headerlink" href="#notes" title="Permalink to this headline">¶</a></h2>
<p>If you are looking for richer media management functionality there is a complete SonataMediaBundle
which caters to this need. It is documented online and is created and maintained by the same team
as SonataAdmin.</p>
<p>To learn how to add an image preview to your ImageAdmin take a look at the related cookbook entry.</p>
</div>
</div>


          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="recipe_image_previews.html" class="btn btn-neutral float-right" title="4. Showing image previews"/>Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="recipe_knp_menu.html" class="btn btn-neutral" title="2. KnpMenu"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2010-2014, Thomas Rabaix.
    </p>
  </div>

  <a href="https://github.com/snide/sphinx_rtd_theme">Sphinx theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>
</footer>
        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>