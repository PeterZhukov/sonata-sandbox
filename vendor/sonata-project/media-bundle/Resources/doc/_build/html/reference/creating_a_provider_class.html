

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>3. Creating a Media Provider: A Vimeo Provider &mdash; Sonata ~ MediaBundle  documentation</title>
  

  
  

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  
    <link rel="top" title="Sonata ~ MediaBundle  documentation" href="../index.html"/>
        <link rel="next" title="4. Media Context" href="media_context.html"/>
        <link rel="prev" title="2. Helpers" href="helpers.html"/> 

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        <a href="../index.html" class="fa fa-home"> Sonata ~ MediaBundle</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        
        
            <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="installation.html">1. Installation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="installation.html#base-bundles">1.1. Base bundles</a></li>
<li class="toctree-l2"><a class="reference internal" href="installation.html#id1">1.2. Installation</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="helpers.html">2. Helpers</a><ul>
<li class="toctree-l2"><a class="reference internal" href="helpers.html#php-usage">2.1. PHP Usage</a></li>
<li class="toctree-l2"><a class="reference internal" href="helpers.html#twig-usage">2.2. Twig usage</a></li>
<li class="toctree-l2"><a class="reference internal" href="helpers.html#thumbnails-for-files">2.3. Thumbnails for files</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="current reference internal" href="">3. Creating a Media Provider: A Vimeo Provider</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#media-entity">3.1. Media Entity</a></li>
<li class="toctree-l2"><a class="reference internal" href="#case-study">3.2. Case Study</a></li>
<li class="toctree-l2"><a class="reference internal" href="#initialize-the-class">3.3. Initialize the class</a></li>
<li class="toctree-l2"><a class="reference internal" href="#register-the-class-with-the-service-container">3.4. Register the Class with the Service Container</a></li>
<li class="toctree-l2"><a class="reference internal" href="#view-helper">3.5. View Helper</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="media_context.html">4. Media Context</a><ul>
<li class="toctree-l2"><a class="reference internal" href="media_context.html#adminbundle-integration">4.1. <tt class="docutils literal"><span class="pre">AdminBundle</span></tt> Integration</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="usage.html">5. Usages</a><ul>
<li class="toctree-l2"><a class="reference internal" href="usage.html#saving-a-media-file">5.1. Saving a media file</a></li>
<li class="toctree-l2"><a class="reference internal" href="usage.html#retrieving-metadata-information">5.2. Retrieving metadata information</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="form.html">6. Form Type</a><ul>
<li class="toctree-l2"><a class="reference internal" href="form.html#media-type">6.1. Media Type</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="security.html">7. Security</a><ul>
<li class="toctree-l2"><a class="reference internal" href="security.html#configuration-example">7.1. Configuration Example</a></li>
<li class="toctree-l2"><a class="reference internal" href="security.html#creating-your-own-security-download-strategy">7.2. Creating your own Security Download Strategy</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="command_line.html">8. Command Line Tools</a><ul>
<li class="toctree-l2"><a class="reference internal" href="command_line.html#media-commands">8.1. Media commands</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="advanced_configuration.html">9. Advanced Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="amazon_s3.html">10. Amazon S3</a><ul>
<li class="toctree-l2"><a class="reference internal" href="amazon_s3.html#configuration">10.1. Configuration</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="extra.html">11. Extra</a><ul>
<li class="toctree-l2"><a class="reference internal" href="extra.html#pixlr-integration">11.1. Pixlr Integration</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="extra.html#sonata-notification-bundle-integration">12. Sonata Notification Bundle Integration</a></li>
<li class="toctree-l1"><a class="reference internal" href="extra.html#liip-imagine-bundle-integration">13. Liip Imagine Bundle Integration</a></li>
<li class="toctree-l1"><a class="reference internal" href="extra.html#ckeditor-integration">14. CKEditor Integration</a><ul>
<li class="toctree-l2"><a class="reference internal" href="extra.html#medias-in-ckeditor-with-cooptilleulsckeditorsonatamediabundle">14.1. Medias in CKEditor with CoopTilleulsCKEditorSonataMediaBundle</a></li>
<li class="toctree-l2"><a class="reference internal" href="extra.html#medias-in-ckeditor-with-sonataformatterbundle">14.2. Medias in CKEditor with SonataFormatterBundle</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="api.html">15. API</a><ul>
<li class="toctree-l2"><a class="reference internal" href="api.html#setup">15.1. Setup</a></li>
<li class="toctree-l2"><a class="reference internal" href="api.html#serialization">15.2. Serialization</a></li>
<li class="toctree-l2"><a class="reference internal" href="api.html#sending-a-media-file">15.3. Sending a media file</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="troubleshooting.html">16. Troubleshooting</a><ul>
<li class="toctree-l2"><a class="reference internal" href="troubleshooting.html#media-formats">16.1. Media Formats</a></li>
</ul>
</li>
</ul>

        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../index.html">Sonata ~ MediaBundle</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html">Docs</a> &raquo;</li>
      
    <li>3. Creating a Media Provider: A Vimeo Provider</li>
      <li class="wy-breadcrumbs-aside">
        
          <a href="../_sources/reference/creating_a_provider_class.txt" rel="nofollow"> View page source</a>
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            
  <div class="section" id="creating-a-media-provider-a-vimeo-provider">
<h1>3. Creating a Media Provider: A Vimeo Provider<a class="headerlink" href="#creating-a-media-provider-a-vimeo-provider" title="Permalink to this headline">¶</a></h1>
<p>A provider class solves a simple use case: the management of a very specific
type of media.</p>
<p>A youtube video and an image file are two very different types of media and
each cannot be managed by a single class. In the <tt class="docutils literal"><span class="pre">MediaBundle</span></tt>, each is
represented by two provider classes: <tt class="docutils literal"><span class="pre">YoutubeProvider</span></tt> and <tt class="docutils literal"><span class="pre">ImageProvider</span></tt>.</p>
<p>A provider class is responsible for handling common things related to a media
asset:</p>
<ul class="simple">
<li>thumbnails</li>
<li>path</li>
<li>editing the media with a form</li>
<li>storing the media information (metadata)</li>
</ul>
<p>A provider class is always linked to a <tt class="docutils literal"><span class="pre">Filesystem</span></tt> and a <tt class="docutils literal"><span class="pre">CDN</span></tt>. The
filesystem abstraction uses the <tt class="docutils literal"><span class="pre">Gaufrette</span></tt> library. For now there is
only 2 abstracted filesystem available : <tt class="docutils literal"><span class="pre">Local</span></tt> and <tt class="docutils literal"><span class="pre">FTP</span></tt>. The <tt class="docutils literal"><span class="pre">CDN</span></tt>
is used to generated the media asset public url.</p>
<p>By default the filesystem and the CDN use the local filesystem and the current
server for the CDN.</p>
<p>In other words, when you create a provider, you don&#8217;t need to worry about
how media assets are going to be store on the filesystem.</p>
<div class="section" id="media-entity">
<h2>3.1. Media Entity<a class="headerlink" href="#media-entity" title="Permalink to this headline">¶</a></h2>
<p>The <tt class="docutils literal"><span class="pre">Media</span></tt> entity comes with common media fields: <tt class="docutils literal"><span class="pre">size</span></tt>, <tt class="docutils literal"><span class="pre">length</span></tt>,
<tt class="docutils literal"><span class="pre">width</span></tt> and <tt class="docutils literal"><span class="pre">height</span></tt>. However the provider might require you to add more
information. As it is not possible to store all of the possible information
into database columns, the provider class can use the <tt class="docutils literal"><span class="pre">provider_metadata</span></tt>
field to store metadata as a serialized array.</p>
<p>The <tt class="docutils literal"><span class="pre">Media</span></tt> entity has 3 other provider fields:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">provider_name</span></tt>: the service name linked to the media</li>
<li><tt class="docutils literal"><span class="pre">provider_status</span></tt>: the media status</li>
<li><tt class="docutils literal"><span class="pre">provider_reference</span></tt>: the internal provider reference (the video sig for instance)</li>
</ul>
</div>
<div class="section" id="case-study">
<h2>3.2. Case Study<a class="headerlink" href="#case-study" title="Permalink to this headline">¶</a></h2>
<p>Before starting, we need to collect information about some asset on vimeo.
Take this video, for example:</p>
<ul class="simple">
<li>video identifier format : 21216091</li>
<li>video player documentation : <a class="reference external" href="http://vimeo.com/api/docs/moogaloop">http://vimeo.com/api/docs/moogaloop</a></li>
<li>metadata : <a class="reference external" href="http://vimeo.com/api/oembed.json?url=http://vimeo.com/21216091">http://vimeo.com/api/oembed.json?url=http://vimeo.com/21216091</a></li>
</ul>
<div class="highlight-json"><div class="highlight"><pre><span class="p">{</span>
  <span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="s2">&quot;video&quot;</span><span class="p">,</span>
  <span class="nt">&quot;version&quot;</span><span class="p">:</span><span class="s2">&quot;1.0&quot;</span><span class="p">,</span>
  <span class="nt">&quot;provider_name&quot;</span><span class="p">:</span><span class="s2">&quot;Vimeo&quot;</span><span class="p">,</span>
  <span class="nt">&quot;provider_url&quot;</span><span class="p">:</span><span class="s2">&quot;http:\/\/vimeo.com\/&quot;</span><span class="p">,</span>
  <span class="nt">&quot;title&quot;</span><span class="p">:</span><span class="s2">&quot;Blinky\u2122&quot;</span><span class="p">,</span>
  <span class="nt">&quot;author_name&quot;</span><span class="p">:</span><span class="s2">&quot;Ruairi Robinson&quot;</span><span class="p">,</span>
  <span class="nt">&quot;author_url&quot;</span><span class="p">:</span><span class="s2">&quot;http:\/\/vimeo.com\/ruairirobinson&quot;</span><span class="p">,</span>
  <span class="nt">&quot;is_plus&quot;</span><span class="p">:</span><span class="s2">&quot;1&quot;</span><span class="p">,</span>
  <span class="nt">&quot;html&quot;</span><span class="p">:</span><span class="s2">&quot;&lt;iframe src=\&quot;http:\/\/player.vimeo.com\/video\/21216091\&quot; width=\&quot;1920\&quot; height=\&quot;1080\&quot; frameborder=\&quot;0\&quot;&gt;&lt;\/iframe&gt;&quot;</span><span class="p">,</span>
  <span class="nt">&quot;width&quot;</span><span class="p">:</span><span class="s2">&quot;1920&quot;</span><span class="p">,</span>
  <span class="nt">&quot;height&quot;</span><span class="p">:</span><span class="s2">&quot;1080&quot;</span><span class="p">,</span>
  <span class="nt">&quot;duration&quot;</span><span class="p">:</span><span class="s2">&quot;771&quot;</span><span class="p">,</span>
  <span class="nt">&quot;description&quot;</span><span class="p">:</span><span class="s2">&quot;Soon every home will have a robot helper. \n\nDon&#39;t worry. \n\nIt&#39;s perfectly safe.\n\n\n\nWritten &amp; Directed by Ruairi Robinson\n\nStarring Max Records from \&quot;Where The Wild Things Are\&quot;.\n\nCinematography by Macgregor&quot;</span><span class="p">,</span>
  <span class="nt">&quot;thumbnail_url&quot;</span><span class="p">:</span><span class="s2">&quot;http:\/\/b.vimeocdn.com\/ts\/136\/375\/136375440_1280.jpg&quot;</span><span class="p">,</span>
  <span class="nt">&quot;thumbnail_width&quot;</span><span class="p">:</span><span class="mi">1280</span><span class="p">,</span>
  <span class="nt">&quot;thumbnail_height&quot;</span><span class="p">:</span><span class="mi">720</span><span class="p">,</span>
  <span class="nt">&quot;video_id&quot;</span><span class="p">:</span><span class="s2">&quot;21216091&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The metadata contains all information we want.</p>
</div>
<div class="section" id="initialize-the-class">
<h2>3.3. Initialize the class<a class="headerlink" href="#initialize-the-class" title="Permalink to this headline">¶</a></h2>
<p>Let&#8217;s initialize the <tt class="docutils literal"><span class="pre">VimeoProvider</span></tt> class.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="k">namespace</span> <span class="nx">Sonata\MediaBundle\Provider</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Sonata\MediaBundle\Provider\BaseProvider</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Sonata\AdminBundle\Form\FormMapper</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Sonata\MediaBundle\Model\MediaInterface</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\Form\Form</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">VimeoProvider</span> <span class="k">extends</span> <span class="nx">BaseProvider</span>
<span class="p">{</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Next, we need to define the create and edit forms. There are two forms because
the workflow is not the same:</p>
<ul class="simple">
<li><em>create</em>: displays only one input text representing the video identifier;</li>
<li><em>edit</em>: displays all information about the media: the edit form should not
be used to edit the metadata information as the metadata is only used
internally by the provider class.</li>
</ul>
<p>The <tt class="docutils literal"><span class="pre">MediaAdmin</span></tt> class, used by the <tt class="docutils literal"><span class="pre">AdminBundle</span></tt>, does not know how
to create the form as the form is unique per provider. So the <tt class="docutils literal"><span class="pre">MediaAdmin</span></tt>
delegates this definition to the related provider.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">buildCreateForm</span><span class="p">(</span><span class="nx">FormMapper</span> <span class="nv">$formMapper</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nv">$formMapper</span><span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="s1">&#39;binaryContent&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(),</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;type&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;string&#39;</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">function</span> <span class="nf">buildEditForm</span><span class="p">(</span><span class="nx">FormMapper</span> <span class="nv">$formMapper</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nv">$formMapper</span><span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">);</span>
    <span class="nv">$formMapper</span><span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="s1">&#39;enabled&#39;</span><span class="p">);</span>
    <span class="nv">$formMapper</span><span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="s1">&#39;authorName&#39;</span><span class="p">);</span>
    <span class="nv">$formMapper</span><span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="s1">&#39;cdnIsFlushable&#39;</span><span class="p">);</span>
    <span class="nv">$formMapper</span><span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">);</span>
    <span class="nv">$formMapper</span><span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="s1">&#39;copyright&#39;</span><span class="p">);</span>
    <span class="nv">$formMapper</span><span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="s1">&#39;binaryContent&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(),</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;type&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;string&#39;</span><span class="p">));</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Once the form is submitted, we retrieve the video metadata. The metadata
is going to be used to store <tt class="docutils literal"><span class="pre">Media</span></tt> information :</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">getMetadata</span><span class="p">(</span><span class="nx">MediaInterface</span> <span class="nv">$media</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$media</span><span class="o">-&gt;</span><span class="na">getBinaryContent</span><span class="p">())</span> <span class="p">{</span>

        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nv">$url</span> <span class="o">=</span> <span class="nb">sprintf</span><span class="p">(</span><span class="s1">&#39;http://vimeo.com/api/oembed.json?url=http://vimeo.com/%s&#39;</span><span class="p">,</span> <span class="nv">$media</span><span class="o">-&gt;</span><span class="na">getBinaryContent</span><span class="p">());</span>
    <span class="nv">$metadata</span> <span class="o">=</span> <span class="o">@</span><span class="nb">file_get_contents</span><span class="p">(</span><span class="nv">$url</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$metadata</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">\RuntimeException</span><span class="p">(</span><span class="s1">&#39;Unable to retrieve vimeo video information for :&#39;</span> <span class="o">.</span> <span class="nv">$url</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nv">$metadata</span> <span class="o">=</span> <span class="nb">json_decode</span><span class="p">(</span><span class="nv">$metadata</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$metadata</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">\RuntimeException</span><span class="p">(</span><span class="s1">&#39;Unable to decode vimeo video information for :&#39;</span> <span class="o">.</span> <span class="nv">$url</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nv">$metadata</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Now, we need to code the logic for the create mode. The <tt class="docutils literal"><span class="pre">$media</span></tt> contains
data from the <tt class="docutils literal"><span class="pre">POST</span></tt>. The <tt class="docutils literal"><span class="pre">AdminBundle</span></tt> always calls specific methods
while saving an object :</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">prePersist</span></tt> / <tt class="docutils literal"><span class="pre">postPersist</span></tt></li>
<li><tt class="docutils literal"><span class="pre">preUpdate</span></tt> / <tt class="docutils literal"><span class="pre">postUpdate</span></tt></li>
</ul>
<p>The <tt class="docutils literal"><span class="pre">MediaAdmin</span></tt> delegates this management to the media provider.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">prePersist</span><span class="p">(</span><span class="nx">MediaInterface</span> <span class="nv">$media</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$media</span><span class="o">-&gt;</span><span class="na">getBinaryContent</span><span class="p">())</span> <span class="p">{</span>

        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// retrieve metadata</span>
    <span class="nv">$metadata</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getMetadata</span><span class="p">(</span><span class="nv">$media</span><span class="p">);</span>

    <span class="c1">// store provider information</span>
    <span class="nv">$media</span><span class="o">-&gt;</span><span class="na">setProviderName</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">name</span><span class="p">);</span>
    <span class="nv">$media</span><span class="o">-&gt;</span><span class="na">setProviderReference</span><span class="p">(</span><span class="nv">$media</span><span class="o">-&gt;</span><span class="na">getBinaryContent</span><span class="p">());</span>
    <span class="nv">$media</span><span class="o">-&gt;</span><span class="na">setProviderMetadata</span><span class="p">(</span><span class="nv">$metadata</span><span class="p">);</span>

    <span class="c1">// update Media common field from metadata</span>
    <span class="nv">$media</span><span class="o">-&gt;</span><span class="na">setName</span><span class="p">(</span><span class="nv">$metadata</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]);</span>
    <span class="nv">$media</span><span class="o">-&gt;</span><span class="na">setDescription</span><span class="p">(</span><span class="nv">$metadata</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]);</span>
    <span class="nv">$media</span><span class="o">-&gt;</span><span class="na">setAuthorName</span><span class="p">(</span><span class="nv">$metadata</span><span class="p">[</span><span class="s1">&#39;author_name&#39;</span><span class="p">]);</span>
    <span class="nv">$media</span><span class="o">-&gt;</span><span class="na">setHeight</span><span class="p">(</span><span class="nv">$metadata</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">]);</span>
    <span class="nv">$media</span><span class="o">-&gt;</span><span class="na">setWidth</span><span class="p">(</span><span class="nv">$metadata</span><span class="p">[</span><span class="s1">&#39;width&#39;</span><span class="p">]);</span>
    <span class="nv">$media</span><span class="o">-&gt;</span><span class="na">setLength</span><span class="p">(</span><span class="nv">$metadata</span><span class="p">[</span><span class="s1">&#39;duration&#39;</span><span class="p">]);</span>
    <span class="nv">$media</span><span class="o">-&gt;</span><span class="na">setContentType</span><span class="p">(</span><span class="s1">&#39;video/x-flv&#39;</span><span class="p">);</span>
    <span class="nv">$media</span><span class="o">-&gt;</span><span class="na">setProviderStatus</span><span class="p">(</span><span class="nx">Media</span><span class="o">::</span><span class="na">STATUS_OK</span><span class="p">);</span>

    <span class="nv">$media</span><span class="o">-&gt;</span><span class="na">setCreatedAt</span><span class="p">(</span><span class="k">new</span> <span class="nx">\Datetime</span><span class="p">());</span>
    <span class="nv">$media</span><span class="o">-&gt;</span><span class="na">setUpdatedAt</span><span class="p">(</span><span class="k">new</span> <span class="nx">\Datetime</span><span class="p">());</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The update method should only update data that cannot be managed by the user.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">preUpdate</span><span class="p">(</span><span class="nx">MediaInterface</span> <span class="nv">$media</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$media</span><span class="o">-&gt;</span><span class="na">getBinaryContent</span><span class="p">())</span> <span class="p">{</span>

        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nv">$metadata</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getMetadata</span><span class="p">(</span><span class="nv">$media</span><span class="p">);</span>

    <span class="nv">$media</span><span class="o">-&gt;</span><span class="na">setProviderReference</span><span class="p">(</span><span class="nv">$media</span><span class="o">-&gt;</span><span class="na">getBinaryContent</span><span class="p">());</span>
    <span class="nv">$media</span><span class="o">-&gt;</span><span class="na">setProviderMetadata</span><span class="p">(</span><span class="nv">$metadata</span><span class="p">);</span>
    <span class="nv">$media</span><span class="o">-&gt;</span><span class="na">setHeight</span><span class="p">(</span><span class="nv">$metadata</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">]);</span>
    <span class="nv">$media</span><span class="o">-&gt;</span><span class="na">setWidth</span><span class="p">(</span><span class="nv">$metadata</span><span class="p">[</span><span class="s1">&#39;width&#39;</span><span class="p">]);</span>
    <span class="nv">$media</span><span class="o">-&gt;</span><span class="na">setProviderStatus</span><span class="p">(</span><span class="nx">Media</span><span class="o">::</span><span class="na">STATUS_OK</span><span class="p">);</span>

    <span class="nv">$media</span><span class="o">-&gt;</span><span class="na">setUpdatedAt</span><span class="p">(</span><span class="k">new</span> <span class="nx">\Datetime</span><span class="p">());</span>
<span class="p">}</span>
</pre></div>
</div>
<p>At this point, the <tt class="docutils literal"><span class="pre">Media</span></tt> object is populated with data from the vimeo&#8217;s
JSON definition and is ready to be saved. However once saved, the provider
needs to generate the correct thumbnails.</p>
<p>The <tt class="docutils literal"><span class="pre">postPersist</span></tt> and <tt class="docutils literal"><span class="pre">postUpdate</span></tt> must be implemented to generate valid
thumbnails.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">postUpdate</span><span class="p">(</span><span class="nx">MediaInterface</span> <span class="nv">$media</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">postPersist</span><span class="p">(</span><span class="nv">$media</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">function</span> <span class="nf">postPersist</span><span class="p">(</span><span class="nx">MediaInterface</span> <span class="nv">$media</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$media</span><span class="o">-&gt;</span><span class="na">getBinaryContent</span><span class="p">())</span> <span class="p">{</span>

        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">generateThumbnails</span><span class="p">(</span><span class="nv">$media</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">generateThumbnails</span></tt> method is defined in the <tt class="docutils literal"><span class="pre">BaseProvider</span></tt> class.
This method required a <tt class="docutils literal"><span class="pre">getReferenceImage</span></tt> method that returns the reference
image.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">getReferenceImage</span><span class="p">(</span><span class="nx">MediaInterface</span> <span class="nv">$media</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="nv">$media</span><span class="o">-&gt;</span><span class="na">getMetadataValue</span><span class="p">(</span><span class="s1">&#39;thumbnail_url&#39;</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>At this point, the provider class is almost finish: we can add and remove
a vimeo video : thanks to the <tt class="docutils literal"><span class="pre">AdminBundle</span></tt> integration and the <tt class="docutils literal"><span class="pre">VimeoProvider</span></tt>
service.</p>
</div>
<div class="section" id="register-the-class-with-the-service-container">
<h2>3.4. Register the Class with the Service Container<a class="headerlink" href="#register-the-class-with-the-service-container" title="Permalink to this headline">¶</a></h2>
<p>If you use the tag <tt class="docutils literal"><span class="pre">sonata.media.provider</span></tt>, the provider service will be
added to the provider pool.</p>
<div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;service</span> <span class="na">id=</span><span class="s">&quot;sonata.media.provider.vimeo&quot;</span> <span class="na">class=</span><span class="s">&quot;Sonata\MediaBundle\Provider\VimeoProvider&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;tag</span> <span class="na">name=</span><span class="s">&quot;sonata.media.provider&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;argument&gt;</span>sonata.media.provider.vimeo<span class="nt">&lt;/argument&gt;</span>
    <span class="nt">&lt;argument</span> <span class="na">type=</span><span class="s">&quot;service&quot;</span> <span class="na">id=</span><span class="s">&quot;sonata.media.filesystem.local&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;argument</span> <span class="na">type=</span><span class="s">&quot;service&quot;</span> <span class="na">id=</span><span class="s">&quot;sonata.media.cdn.server&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;argument</span> <span class="na">type=</span><span class="s">&quot;service&quot;</span> <span class="na">id=</span><span class="s">&quot;sonata.media.generator.default&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;argument</span> <span class="na">type=</span><span class="s">&quot;service&quot;</span> <span class="na">id=</span><span class="s">&quot;sonata.media.thumbnail.format&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;argument</span> <span class="na">type=</span><span class="s">&quot;service&quot;</span> <span class="na">id=</span><span class="s">&quot;sonata.media.buzz.browser&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;argument</span> <span class="na">type=</span><span class="s">&quot;service&quot;</span> <span class="na">id=</span><span class="s">&quot;sonata.media.metadata.proxy&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;call</span> <span class="na">method=</span><span class="s">&quot;setTemplates&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;argument</span> <span class="na">type=</span><span class="s">&quot;collection&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;argument</span> <span class="na">key=</span><span class="s">&#39;helper_thumbnail&#39;</span><span class="nt">&gt;</span>SonataMediaBundle:Provider:thumbnail.html.twig<span class="nt">&lt;/argument&gt;</span>
            <span class="nt">&lt;argument</span> <span class="na">key=</span><span class="s">&#39;helper_view&#39;</span><span class="nt">&gt;</span>SonataMediaBundle:Provider:view_vimeo.html.twig<span class="nt">&lt;/argument&gt;</span>
        <span class="nt">&lt;/argument&gt;</span>
    <span class="nt">&lt;/call&gt;</span>
    <span class="nt">&lt;call</span> <span class="na">method=</span><span class="s">&quot;setResizer&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;argument</span> <span class="na">type=</span><span class="s">&quot;service&quot;</span> <span class="na">id=</span><span class="s">&quot;sonata.media.resizer.simple&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/call&gt;</span>
<span class="nt">&lt;/service&gt;</span>
</pre></div>
</div>
<p>The last important part is how the vimeo media should be displayed.</p>
</div>
<div class="section" id="view-helper">
<h2>3.5. View Helper<a class="headerlink" href="#view-helper" title="Permalink to this headline">¶</a></h2>
<p>The <tt class="docutils literal"><span class="pre">MediaBundle</span></tt> comes with 2 helper methods:</p>
<ul class="simple">
<li><em>thumbnail</em>: This method displays the thumbnail depending on the requested
format. The thumbnail path generation uses the CDN service injected into
the provider. By default, the <tt class="docutils literal"><span class="pre">sonata.media.cdn.server</span></tt> service is used.
The server is just the local http server.</li>
<li><em>media</em>: This methods displays the media. In the current case, the media
is the vimeo player. Depending on the provider, the method <tt class="docutils literal"><span class="pre">getHelperProperties</span></tt>
is called to normalize the available options.</li>
</ul>
<p>The thumbnail template is common to all media and it is quite simple:</p>
<div class="highlight-html+jinja"><div class="highlight"><pre>&lt;img {% for name, value in options %}{{name}}=&quot;{{value}}&quot; {% endfor %} /&gt;
</pre></div>
</div>
<p>The media template and media helper are a bit more tricky. Each provider might
provide a rich set of options to embed the media. The
<tt class="docutils literal"><span class="pre">VideoProvider::getHelperProperties()</span></tt> method generates the correct set
of options that need to be passed to the <tt class="docutils literal"><span class="pre">view_vimeo.html.twig</span></tt> template file.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">getHelperProperties</span><span class="p">(</span><span class="nx">Media</span> <span class="nv">$media</span><span class="p">,</span> <span class="nv">$format</span><span class="p">,</span> <span class="nv">$options</span> <span class="o">=</span> <span class="k">array</span><span class="p">())</span>
<span class="p">{</span>
    <span class="c1">// documentation : http://vimeo.com/api/docs/moogaloop</span>
    <span class="nv">$defaults</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
        <span class="c1">// (optional) Flash Player version of app. Defaults to 9 .NEW!</span>
        <span class="c1">// 10 - New Moogaloop. 9 - Old Moogaloop without newest features.</span>
        <span class="s1">&#39;fp_version&#39;</span>      <span class="o">=&gt;</span> <span class="mi">10</span><span class="p">,</span>

        <span class="c1">// (optional) Enable fullscreen capability. Defaults to true.</span>
        <span class="s1">&#39;fullscreen&#39;</span> <span class="o">=&gt;</span> <span class="k">true</span><span class="p">,</span>

        <span class="c1">// (optional) Show the byline on the video. Defaults to true.</span>
        <span class="s1">&#39;title&#39;</span> <span class="o">=&gt;</span> <span class="k">true</span><span class="p">,</span>

        <span class="c1">// (optional) Show the title on the video. Defaults to true.</span>
        <span class="s1">&#39;byline&#39;</span> <span class="o">=&gt;</span> <span class="mi">0</span><span class="p">,</span>

        <span class="c1">// (optional) Show the user&#39;s portrait on the video. Defaults to true.</span>
        <span class="s1">&#39;portrait&#39;</span> <span class="o">=&gt;</span> <span class="k">true</span><span class="p">,</span>

        <span class="c1">// (optional) Specify the color of the video controls.</span>
        <span class="s1">&#39;color&#39;</span> <span class="o">=&gt;</span> <span class="k">null</span><span class="p">,</span>

        <span class="c1">// (optional) Set to 1 to disable HD.</span>
        <span class="s1">&#39;hd_off&#39;</span> <span class="o">=&gt;</span> <span class="mi">0</span><span class="p">,</span>

        <span class="c1">// Set to 1 to enable the Javascript API.</span>
        <span class="s1">&#39;js_api&#39;</span> <span class="o">=&gt;</span> <span class="k">null</span><span class="p">,</span>

        <span class="c1">// (optional) JS function called when the player loads. Defaults to vimeo_player_loaded.</span>
        <span class="s1">&#39;js_onLoad&#39;</span> <span class="o">=&gt;</span> <span class="mi">0</span><span class="p">,</span>

        <span class="c1">// Unique id that is passed into all player events as the ending parameter.</span>
        <span class="s1">&#39;js_swf_id&#39;</span> <span class="o">=&gt;</span> <span class="nb">uniqid</span><span class="p">(</span><span class="s1">&#39;vimeo_player_&#39;</span><span class="p">),</span>
    <span class="p">);</span>

    <span class="nv">$player_parameters</span> <span class="o">=</span>  <span class="nb">array_merge</span><span class="p">(</span><span class="nv">$defaults</span><span class="p">,</span> <span class="nb">isset</span><span class="p">(</span><span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;player_parameters&#39;</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;player_parameters&#39;</span><span class="p">]</span> <span class="o">:</span> <span class="k">array</span><span class="p">());</span>

    <span class="nv">$params</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
        <span class="s1">&#39;src&#39;</span>         <span class="o">=&gt;</span> <span class="nb">http_build_query</span><span class="p">(</span><span class="nv">$player_parameters</span><span class="p">),</span>
        <span class="s1">&#39;id&#39;</span>          <span class="o">=&gt;</span> <span class="nv">$player_parameters</span><span class="p">[</span><span class="s1">&#39;js_swf_id&#39;</span><span class="p">],</span>
        <span class="s1">&#39;frameborder&#39;</span> <span class="o">=&gt;</span> <span class="nb">isset</span><span class="p">(</span><span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;frameborder&#39;</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;frameborder&#39;</span><span class="p">]</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;width&#39;</span>       <span class="o">=&gt;</span> <span class="nb">isset</span><span class="p">(</span><span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;width&#39;</span><span class="p">])</span>             <span class="o">?</span> <span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;width&#39;</span><span class="p">]</span>  <span class="o">:</span> <span class="nv">$media</span><span class="o">-&gt;</span><span class="na">getWidth</span><span class="p">(),</span>
        <span class="s1">&#39;height&#39;</span>      <span class="o">=&gt;</span> <span class="nb">isset</span><span class="p">(</span><span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">])</span>            <span class="o">?</span> <span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">]</span> <span class="o">:</span> <span class="nv">$media</span><span class="o">-&gt;</span><span class="na">getHeight</span><span class="p">(),</span>
    <span class="p">);</span>

    <span class="k">return</span> <span class="nv">$params</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>From the vimeo&#8217;s documentation, a video can be included like this:</p>
<div class="highlight-html+jinja"><div class="highlight"><pre><span class="nt">&lt;iframe</span>
    <span class="na">id=</span><span class="s">&quot;</span><span class="cp">{{</span> <span class="nv">options.id</span> <span class="cp">}}</span><span class="s">&quot;</span>
    <span class="na">src=</span><span class="s">&quot;http://player.vimeo.com/video/</span><span class="cp">{{</span> <span class="nv">media.providerreference</span> <span class="cp">}}</span><span class="s">?</span><span class="cp">{{</span> <span class="nv">options.src</span> <span class="cp">}}</span><span class="s">&quot;</span>
    <span class="na">width=</span><span class="s">&quot;</span><span class="cp">{{</span> <span class="nv">options.width</span> <span class="cp">}}</span><span class="s">&quot;</span>
    <span class="na">height=</span><span class="s">&quot;</span><span class="cp">{{</span> <span class="nv">options.height</span> <span class="cp">}}</span><span class="s">&quot;</span>
    <span class="na">frameborder=</span><span class="s">&quot;</span><span class="cp">{{</span> <span class="nv">options.frameborder</span> <span class="cp">}}</span><span class="s">&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;/iframe&gt;</span>
</pre></div>
</div>
<p>Et voilà! Of course you should test the provider class. There are many examples
in the <tt class="docutils literal"><span class="pre">Tests</span></tt> folder. The source code is available in the class
<tt class="docutils literal"><span class="pre">Sonata\MediaBundle\Provider\VimeoProvider</span></tt>.</p>
</div>
</div>


          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="media_context.html" class="btn btn-neutral float-right" title="4. Media Context"/>Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="helpers.html" class="btn btn-neutral" title="2. Helpers"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2010-2014, Thomas Rabaix.
    </p>
  </div>

  <a href="https://github.com/snide/sphinx_rtd_theme">Sphinx theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>
</footer>
        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>